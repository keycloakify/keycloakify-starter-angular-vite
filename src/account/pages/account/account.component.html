@let url = kcContext.url;
@let realm = kcContext.realm;
@let messagesPerField = kcContext.messagesPerField;
@let stateChecker = kcContext.stateChecker;
@let referrer = kcContext.referrer;

@let userProfile = userProfile$ | async;
@let i18nMessages = i18nMessages$ | async;

@if (userProfile && i18nMessages) {
  <div class="row">
    <div class="col-md-10">
      <h2>{{ i18n.msgStr('editAccountHtmlTitle') }}</h2>
    </div>
    <div class="col-md-2 subtitle">
      <span class="subtitle"> <span class="required">*</span> {{ i18n.msgStr('requiredFields') }} </span>
    </div>
  </div>
  <form
    class="form-horizontal"
    method="post"
    [action]="url.accountUrl"
  >
    <input
      type="hidden"
      id="stateChecker"
      name="stateChecker"
      [value]="stateChecker"
    />
    @if (!realm.registrationEmailAsUsername) {
      <div
        class="form-group"
        [ngClass]="{ 'has-error': messagesPerField.existsError('username') }"
      >
        <div class="col-sm-2 col-md-2">
          <label
            for="username"
            class="control-label"
          >
            {{ i18n.msgStr('username') }}
          </label>
          @if (realm.editUsernameAllowed) {
            <span class="required">*</span>
          }
        </div>

        <div class="col-sm-10 col-md-10">
          <input
            type="text"
            class="form-control"
            id="username"
            name="username"
            [disabled]="!realm.editUsernameAllowed"
            [defaultValue]="userProfile.username"
          />
        </div>
      </div>
    }

    <div
      class="form-group"
      [ngClass]="{ 'has-error': messagesPerField.existsError('email') }"
    >
      <div class="col-sm-2 col-md-2">
        <label
          for="email"
          class="control-label"
        >
          {{ i18n.msgStr('email') }}
        </label>
        <span class="required">*</span>
      </div>

      <div class="col-sm-10 col-md-10">
        <input
          type="text"
          class="form-control"
          id="email"
          name="email"
          autoFocus
          [defaultValue]="userProfile.email"
        />
      </div>
    </div>

    <div
      class="form-group"
      [ngClass]="{ 'has-error': messagesPerField.existsError('firstName') }"
    >
      <div class="col-sm-2 col-md-2">
        <label
          for="firstName"
          class="control-label"
        >
          {{ i18n.msgStr('firstName') }}
        </label>
        <span class="required">*</span>
      </div>

      <div class="col-sm-10 col-md-10">
        <input
          type="text"
          class="form-control"
          id="firstName"
          name="firstName"
          [defaultValue]="userProfile.firstName"
        />
      </div>
    </div>

    <div
      class="form-group"
      [ngClass]="{ 'has-error': messagesPerField.existsError('lastName') }"
    >
      <div class="col-sm-2 col-md-2">
        <label
          for="lastName"
          class="control-label"
        >
          {{ i18n.msgStr('lastName') }}
        </label>
        <span class="required">*</span>
      </div>

      <div class="col-sm-10 col-md-10">
        <input
          type="text"
          class="form-control"
          id="lastName"
          name="lastName"
          [defaultValue]="userProfile.lastName"
        />
      </div>
    </div>

    <div class="form-group">
      <div
        id="kc-form-buttons"
        class="col-md-offset-2 col-md-10 submit"
      >
        <div>
          @if (referrer) {
            <a [href]="referrer?.url">{{ i18n.msgStr('backToApplication') }}</a>
          }
          <button
            type="submit"
            name="submitAction"
            value="Save"
            [kcClass]="['kcButtonClass', 'kcButtonPrimaryClass', 'kcButtonLargeClass']"
          >
            {{ i18n.msgStr('doSave') }}
          </button>
          <button
            type="submit"
            name="submitAction"
            value="Cancel"
            [kcClass]="['kcButtonClass', 'kcButtonPrimaryClass', 'kcButtonLargeClass']"
          >
            {{ i18n.msgStr('doCancel') }}
          </button>
        </div>
      </div>
    </div>
  </form>
  <br />
  <br />
  -- OR: Instead of re-implementing the form, simply redirect to the page of you account theme to enable the user to
  update their profile info --
  <br />
  @let backFromAuthServer = backFromAuthServer$ | async;
  @if (backFromAuthServer?.extraQueryParams?.['kc_action'] === 'UPDATE_PROFILE') {
    <p>
      @switch (backFromAuthServer?.result?.['kc_action_status']) {
        @case ('success') {
          Profile successfully updated
        }
        @case ('cancelled') {
          Profile unchanged
        }
      }
    </p>
  }
  <br />
  <button
    [kcClass]="['kcButtonClass', 'kcButtonPrimaryClass', 'kcButtonLargeClass']"
    (click)="
      goToAuthServer({
        extraQueryParams: { kc_action: 'UPDATE_PROFILE' },
      })
    "
  >
    Update profile (via Login theme)
  </button>
  <br />
  <br />
  -- Optionally add a button to enable users to delete their account (if enabled in your keycloak configuration) --
  <br />
  <br />
  <button
    [kcClass]="['kcButtonClass', 'kcButtonPrimaryClass', 'kcButtonLargeClass']"
    (click)="
      goToAuthServer({
        extraQueryParams: { kc_action: 'delete_account' },
      })
    "
  >
    Delete Account
  </button>
  @if (kcContext.features.passwordUpdateSupported) {
    <br />
    <br />
    -- You can also add a button to enable users to change their password --
    <br />
    <br />
    <button
      [kcClass]="['kcButtonClass', 'kcButtonPrimaryClass', 'kcButtonLargeClass']"
      (click)="
        goToAuthServer({
          extraQueryParams: { kc_action: 'UPDATE_PASSWORD' },
        })
      "
      [innerHTML]="i18n.msgStr('changePasswordHtmlTitle') | kcSanitize: 'html'"
    ></button>
    @if (backFromAuthServer?.extraQueryParams?.['kc_action'] === 'UPDATE_PASSWORD') {
      <p>
        @switch (backFromAuthServer?.result?.['kc_action_status']) {
          @case ('success') {
            Password successfully updated
          }
          @case ('cancelled') {
            Password unchanged
          }
        }
      </p>
    }
  }
}
